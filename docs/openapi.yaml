openapi: 3.1.0
info:
  title: HelpDesk API (AS-IS)
  version: 0.1.0
  description: OpenAPI baseline reflecting currently implemented routes.
servers:
  - url: https://example.com
    description: Replace with deployment host
components:
  securitySchemes:
    cookieAuth:
      type: apiKey
      in: cookie
      name: next-auth.session-token
  schemas:
    ErrorAsIs:
      type: object
      properties:
        error:
          oneOf:
            - type: string
            - type: object
              additionalProperties: true
    UserSummary:
      type: object
      properties:
        id:
          type: string
          format: uuid
        email:
          type: string
          format: email
        name:
          type: string
        role:
          type: string
        organizationId:
          type: string
          format: uuid
      additionalProperties: true
    TeamSummary:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        organizationId:
          type: string
          format: uuid
      additionalProperties: true
    Ticket:
      type: object
      properties:
        id:
          type: string
          format: uuid
        number:
          type: integer
        title:
          type: string
        descriptionMd:
          type: string
        status:
          type: string
          enum: [NOWE, W_TOKU, OCZEKUJE_NA_UZYTKOWNIKA, WSTRZYMANE, ROZWIAZANE, ZAMKNIETE, PONOWNIE_OTWARTE]
        priority:
          type: string
          enum: [NISKI, SREDNI, WYSOKI, KRYTYCZNY]
        category:
          type: string
          nullable: true
        requesterId:
          type: string
          format: uuid
        assigneeUserId:
          type: string
          format: uuid
          nullable: true
        assigneeTeamId:
          type: string
          format: uuid
          nullable: true
        organizationId:
          type: string
          format: uuid
        firstResponseAt:
          type: string
          format: date-time
          nullable: true
        firstResponseDue:
          type: string
          format: date-time
          nullable: true
        resolveDue:
          type: string
          format: date-time
          nullable: true
        resolvedAt:
          type: string
          format: date-time
          nullable: true
        closedAt:
          type: string
          format: date-time
          nullable: true
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
    TicketExpanded:
      allOf:
        - $ref: '#/components/schemas/Ticket'
        - type: object
          properties:
            requester:
              $ref: '#/components/schemas/UserSummary'
            assigneeUser:
              $ref: '#/components/schemas/UserSummary'
            assigneeTeam:
              $ref: '#/components/schemas/TeamSummary'
    TicketCreate:
      type: object
      required: [title, descriptionMd, priority]
      properties:
        title:
          type: string
          minLength: 3
        descriptionMd:
          type: string
          minLength: 3
        priority:
          type: string
          enum: [NISKI, SREDNI, WYSOKI, KRYTYCZNY]
        category:
          type: string
          nullable: true
    TicketUpdate:
      type: object
      description: Must include at least one of the fields below; requester-only updates are limited to closing/reopening.
      properties:
        status:
          type: string
          enum: [NOWE, W_TOKU, OCZEKUJE_NA_UZYTKOWNIKA, WSTRZYMANE, ROZWIAZANE, ZAMKNIETE, PONOWNIE_OTWARTE]
        priority:
          type: string
          enum: [NISKI, SREDNI, WYSOKI, KRYTYCZNY]
        assigneeUserId:
          type: string
          format: uuid
          nullable: true
        assigneeTeamId:
          type: string
          format: uuid
          nullable: true
    Comment:
      type: object
      properties:
        id:
          type: string
          format: uuid
        ticketId:
          type: string
          format: uuid
        authorId:
          type: string
          format: uuid
        isInternal:
          type: boolean
        bodyMd:
          type: string
        createdAt:
          type: string
          format: date-time
    CommentCreate:
      type: object
      required: [bodyMd]
      properties:
        bodyMd:
          type: string
          minLength: 1
        isInternal:
          type: boolean
          default: false
    AdminAuditEvent:
      type: object
      properties:
        id:
          type: string
          format: uuid
        action:
          type: string
          enum: [CREATE, UPDATE, DELETE]
        resource:
          type: string
          enum: [USER, TEAM, TAG, SLA]
        resourceId:
          type: string
        actorId:
          type: string
          format: uuid
        actor:
          type: object
          properties:
            id:
              type: string
              format: uuid
            name:
              type: string
              nullable: true
            email:
              type: string
              format: email
        data:
          type: object
          nullable: true
          additionalProperties: true
        createdAt:
          type: string
          format: date-time
    PageInfo:
      type: object
      properties:
        limit:
          type: integer
        offset:
          type: integer
        total:
          type: integer
    WorkerQueueJob:
      type: object
      properties:
        jobId:
          type: string
          format: uuid
        jobType:
          type: string
          description: |-
            Worker queue job type (e.g., `slaBreach`, `slaReminder`, `notificationDispatch`).
        ticketId:
          type: string
          format: uuid
        priority:
          type: string
          enum: [NISKI, SREDNI, WYSOKI, KRYTYCZNY]
        dueAt:
          type: string
          format: date-time
        payload:
          type: object
          additionalProperties: true
      example:
        jobId: 123e4567-e89b-12d3-a456-426655440000
        jobType: slaBreach
        ticketId: 111e4567-e89b-12d3-a456-426655440001
        priority: WYSOKI
        dueAt: 2025-12-22T10:00:00Z
        payload:
          breachType: resolve
    WorkerEvent:
      type: object
      properties:
        eventId:
          type: string
          format: uuid
        eventType:
          type: string
          enum: [slaBreach, slaReminder, notificationSent]
        occurredAt:
          type: string
          format: date-time
        metadata:
          type: object
          additionalProperties: true
        job:
          $ref: '#/components/schemas/WorkerQueueJob'
      example:
        eventId: 223e4567-e89b-12d3-a456-426655440002
        eventType: slaBreach
        occurredAt: 2025-12-22T10:05:00Z
        metadata:
          breachedDurationSeconds: 3600
        job:
          jobId: 123e4567-e89b-12d3-a456-426655440000
          jobType: slaBreach
    NotificationEnvelope:
      type: object
      properties:
        channel:
          type: string
          enum: [email, inApp]
        recipientId:
          type: string
          format: uuid
        subject:
          type: string
        body:
          type: string
        metadata:
          type: object
          additionalProperties: true
      example:
        channel: email
        recipientId: 333e4567-e89b-12d3-a456-426655440003
        subject: "Ticket SLA reminder"
        body: "SLA breach is imminent; please respond."
        metadata:
          ticketId: 111e4567-e89b-12d3-a456-426655440001
  parameters:
    Limit:
      name: limit
      in: query
      schema:
        type: integer
        minimum: 1
        maximum: 50
        default: 10
    Offset:
      name: offset
      in: query
      schema:
        type: integer
        minimum: 0
        default: 0
paths:
  /api/tickets:
    get:
      summary: List tickets
      description: Returns all tickets scoped by role/organization. No server-side pagination, filtering, or sorting is applied.
      security:
        - cookieAuth: []
      parameters:
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Offset'
        - name: status
          in: query
          schema:
            type: string
        - name: priority
          in: query
          schema:
            type: string
        - name: category
          in: query
          schema:
            type: string
          description: Filter by category name.
        - name: tags
          in: query
          description: Tag IDs (comma-separated or repeated values).
          style: form
          explode: false
          schema:
            type: array
            items:
              type: string
      responses:
        '200':
          description: Tickets list
          content:
            application/json:
              schema:
                type: object
                properties:
                  tickets:
                    type: array
                    items:
                      $ref: '#/components/schemas/TicketExpanded'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorAsIs'
    post:
      summary: Create ticket
      description: Validates basic fields and creates a ticket; no idempotency is enforced.
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TicketCreate'
      responses:
        '200':
          description: Ticket created
          content:
            application/json:
              schema:
                type: object
                properties:
                  ticket:
                    $ref: '#/components/schemas/Ticket'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorAsIs'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorAsIs'
  /api/tickets/{id}:
    patch:
      summary: Update ticket
      description: Updates status/priority/assignees with role and organization checks; no If-Match/etag enforcement.
      security:
        - cookieAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TicketUpdate'
      responses:
        '200':
          description: Ticket updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  ticket:
                    $ref: '#/components/schemas/TicketExpanded'
        '400':
          description: Validation or no changes
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorAsIs'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorAsIs'
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorAsIs'
        '404':
          description: Not found or other organization
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorAsIs'
    put:
      summary: Replace ticket (same semantics as PATCH)
      description: Mirrors PATCH behavior and validations.
      security:
        - cookieAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TicketUpdate'
      responses:
        '200':
          description: Ticket updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  ticket:
                    $ref: '#/components/schemas/TicketExpanded'
        '400':
          description: Validation or no changes
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorAsIs'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorAsIs'
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorAsIs'
        '404':
          description: Not found or other organization
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorAsIs'
  /api/tickets/{id}/comments:
    post:
      summary: Create comment
      description: Creates a comment; organization scope is not enforced in the current handler.
      security:
        - cookieAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CommentCreate'
      responses:
        '200':
          description: Comment created
          content:
            application/json:
              schema:
                type: object
                properties:
                  comment:
                    $ref: '#/components/schemas/Comment'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorAsIs'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorAsIs'
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorAsIs'
        '404':
          description: Not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorAsIs'
  /api/admin/audit-events:
    get:
      summary: List admin audit events
      description: Returns paginated admin audit events for the organization. Requires ADMIN role.
      security:
        - cookieAuth: []
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
        - name: offset
          in: query
          schema:
            type: integer
            minimum: 0
            default: 0
        - name: resourceId
          in: query
          schema:
            type: string
          description: Filter by resource ID
        - name: actorId
          in: query
          schema:
            type: string
            format: uuid
          description: Filter by actor user ID
      responses:
        '200':
          description: Audit events list
          content:
            application/json:
              schema:
                type: object
                properties:
                  events:
                    type: array
                    items:
                      $ref: '#/components/schemas/AdminAuditEvent'
                  page:
                    $ref: '#/components/schemas/PageInfo'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorAsIs'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorAsIs'
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorAsIs'
