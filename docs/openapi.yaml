openapi: 3.1.0
info:
  title: HelpDesk API
  version: 0.1.0
  description: Contract-ready OpenAPI covering target ticketing endpoints.
servers:
  - url: https://example.com
    description: Replace with deployment host
components:
  securitySchemes:
    cookieAuth:
      type: apiKey
      in: cookie
      name: next-auth.session-token
  parameters:
    Limit:
      name: limit
      in: query
      schema:
        type: integer
        minimum: 1
        maximum: 100
        default: 20
    Offset:
      name: offset
      in: query
      schema:
        type: integer
        minimum: 0
        default: 0
    Sort:
      name: sort
      in: query
      description: field:direction (createdAt, priority, status)
      schema:
        type: string
  requestBodies:
    TicketCreate:
      required: true
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/TicketCreate'
    TicketUpdate:
      required: true
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/TicketUpdate'
    CommentCreate:
      required: true
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/CommentCreate'
    AttachmentCreate:
      required: true
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/AttachmentCreate'
  responses:
    Unauthorized:
      description: Authentication required
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    Forbidden:
      description: Forbidden
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    NotFound:
      description: Not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
  schemas:
    Error:
      type: object
      required: [code, message]
      properties:
        code:
          type: string
        message:
          type: string
        details:
          type: object
          additionalProperties: true
        traceId:
          type: string
    ErrorResponse:
      type: object
      properties:
        error:
          $ref: '#/components/schemas/Error'
    Ticket:
      type: object
      properties:
        id:
          type: string
          format: uuid
        number:
          type: integer
        title:
          type: string
        descriptionMd:
          type: string
        status:
          type: string
          enum: [NOWE, W_TOKU, OCZEKUJE_NA_UZYTKOWNIKA, WSTRZYMANE, ROZWIAZANE, ZAMKNIETE, PONOWNIE_OTWARTE]
        priority:
          type: string
          enum: [NISKI, SREDNI, WYSOKI, KRYTYCZNY]
        category:
          type: string
          nullable: true
        requesterId:
          type: string
          format: uuid
        assigneeUserId:
          type: string
          format: uuid
          nullable: true
        assigneeTeamId:
          type: string
          format: uuid
          nullable: true
        organizationId:
          type: string
          format: uuid
        firstResponseAt:
          type: string
          format: date-time
          nullable: true
        firstResponseDue:
          type: string
          format: date-time
          nullable: true
        resolveDue:
          type: string
          format: date-time
          nullable: true
        resolvedAt:
          type: string
          format: date-time
          nullable: true
        closedAt:
          type: string
          format: date-time
          nullable: true
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
        tags:
          type: array
          items:
            $ref: '#/components/schemas/Tag'
          description: Target-only; AS-IS handlers do not include tags in responses.
        etag:
          type: string
          description: Target-only concurrency token (hash of updatedAt); AS-IS responses omit this.
    TicketCreate:
      type: object
      required: [title, descriptionMd, priority]
      properties:
        title:
          type: string
          minLength: 3
          maxLength: 140
        descriptionMd:
          type: string
          minLength: 3
          maxLength: 8000
        priority:
          type: string
          enum: [NISKI, SREDNI, WYSOKI, KRYTYCZNY]
        category:
          type: string
          nullable: true
        tags:
          type: array
          items:
            $ref: '#/components/schemas/TagRef'
          description: Target-only; AS-IS creation ignores tags because handlers do not accept or persist them.
    TicketUpdate:
      type: object
      properties:
        status:
          type: string
          enum: [NOWE, W_TOKU, OCZEKUJE_NA_UZYTKOWNIKA, WSTRZYMANE, ROZWIAZANE, ZAMKNIETE, PONOWNIE_OTWARTE]
        priority:
          type: string
          enum: [NISKI, SREDNI, WYSOKI, KRYTYCZNY]
        assigneeUserId:
          type: string
          format: uuid
          nullable: true
        assigneeTeamId:
          type: string
          format: uuid
          nullable: true
    Comment:
      type: object
      properties:
        id:
          type: string
          format: uuid
        ticketId:
          type: string
          format: uuid
        authorId:
          type: string
          format: uuid
        bodyMd:
          type: string
        isInternal:
          type: boolean
        createdAt:
          type: string
          format: date-time
    CommentCreate:
      type: object
      required: [bodyMd]
      properties:
        bodyMd:
          type: string
          minLength: 1
          maxLength: 4000
        isInternal:
          type: boolean
          default: false
    Attachment:
      type: object
      properties:
        id:
          type: string
          format: uuid
        ticketId:
          type: string
          format: uuid
        uploaderId:
          type: string
          format: uuid
        fileName:
          type: string
        mimeType:
          type: string
        sizeBytes:
          type: integer
        status:
          type: string
          enum: [PENDING, CLEAN, REJECTED]
        url:
          type: string
          format: uri
          nullable: true
        createdAt:
          type: string
          format: date-time
    AttachmentCreate:
      type: object
      required: [fileName, mimeType, sizeBytes]
      properties:
        fileName:
          type: string
        mimeType:
          type: string
        sizeBytes:
          type: integer
          maximum: 26214400
    Tag:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
    TagRef:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
paths:
  /api/tickets:
    get:
      summary: List tickets
      description: |
        AS-IS implementation returns `{ tickets }` without pagination, filtering, or sorting and scopes results by role/organization.
        Target behavior adds `limit`/`offset`/`sort` and optional `status`/`priority`/`q` filters plus pagination metadata.
      x-implementation-status: "as-is (pagination/filtering not yet implemented)"
      security:
        - cookieAuth: []
      parameters:
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Offset'
        - $ref: '#/components/parameters/Sort'
        - name: status
          in: query
          schema:
            type: string
        - name: priority
          in: query
          schema:
            type: string
        - name: q
          in: query
          schema:
            type: string
      responses:
        '200':
          description: Tickets list
          content:
            application/json:
              schema:
                type: object
                properties:
                  tickets:
                    type: array
                    items:
                      $ref: '#/components/schemas/Ticket'
                  page:
                    type: object
                    description: Target-only pagination metadata; AS-IS responses omit this object.
                    properties:
                      limit:
                        type: integer
                      offset:
                        type: integer
                      total:
                        type: integer
        '401':
          $ref: '#/components/responses/Unauthorized'
    post:
      summary: Create ticket
      description: |
        AS-IS returns 200 with `{ ticket }` and does not enforce idempotency. Target behavior should return 201, require an
        `Idempotency-Key`, and include pagination-friendly metadata fields such as `etag`.
      x-implementation-status: "as-is (idempotency + 201 response pending)"
      security:
        - cookieAuth: []
      parameters:
        - name: Idempotency-Key
          in: header
          required: false
          description: Target requires this idempotency key; AS-IS handlers ignore it.
          schema:
            type: string
            format: uuid
      requestBody:
        $ref: '#/components/requestBodies/TicketCreate'
      responses:
        '200':
          description: Ticket created (AS-IS returns 200; target may switch to 201)
          content:
            application/json:
              schema:
                type: object
                properties:
                  ticket:
                    $ref: '#/components/schemas/Ticket'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
  /api/tickets/{id}:
    get:
      summary: Get ticket by id
      description: |
        Not implemented in current code. Target behavior should return ticket details with relations when organization scope
        matches; use 404 on scope violations.
      x-implementation-status: "planned (no handler in code)"
      security:
        - cookieAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Offset'
      responses:
        '200':
          description: Ticket detail
          content:
            application/json:
              schema:
                type: object
                properties:
                  ticket:
                    $ref: '#/components/schemas/Ticket'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
    patch:
      summary: Update ticket
      description: |
        AS-IS allows status/priority/assignee updates per role constraints without `If-Match` or etag enforcement and
        returns 200 on success or 400 on validation/no-change. Target adds optimistic locking via `If-Match` and may return
        412 on mismatch.
      x-implementation-status: "as-is (no etag/If-Match)"
      security:
        - cookieAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
        - name: If-Match
          in: header
          required: false
          description: Target will require etag-based updates; AS-IS ignores this header.
          schema:
            type: string
      requestBody:
        $ref: '#/components/requestBodies/TicketUpdate'
      responses:
        '200':
          description: Updated ticket
          content:
            application/json:
              schema:
                type: object
                properties:
                  ticket:
                    $ref: '#/components/schemas/Ticket'
        '400':
          description: Validation or no changes
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '412':
          description: Precondition failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    put:
      summary: Replace ticket (alias for patch behavior)
      description: |
        Mirrors PATCH. Same AS-IS behavior without `If-Match`; target may require it.
      x-implementation-status: "as-is (no etag/If-Match)"
      security:
        - cookieAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
        - name: If-Match
          in: header
          required: false
          description: Target will require etag-based updates; AS-IS ignores this header.
          schema:
            type: string
      requestBody:
        $ref: '#/components/requestBodies/TicketUpdate'
      responses:
        '200':
          description: Updated ticket
          content:
            application/json:
              schema:
                type: object
                properties:
                  ticket:
                    $ref: '#/components/schemas/Ticket'
        '400':
          description: Validation or no changes
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '412':
          description: Precondition failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/tickets/{id}/comments:
    get:
      summary: List comments for ticket
      description: |
        Not implemented in current code. Target behavior paginates comments and hides internal notes from requesters.
      x-implementation-status: "planned (no handler in code)"
      security:
        - cookieAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
        - $ref: '#/components/parameters/Limit'
        - name: cursor
          in: query
          schema:
            type: string
      responses:
        '200':
          description: Comments
          content:
            application/json:
              schema:
                type: object
                properties:
                  comments:
                    type: array
                    items:
                      $ref: '#/components/schemas/Comment'
                  page:
                    type: object
                    properties:
                      limit:
                        type: integer
                      cursor:
                        type: string
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
    post:
      summary: Create comment
      description: |
        AS-IS accepts `bodyMd` and optional `isInternal` (default false), stamps `firstResponseAt` for first public agent
        comment, and returns 200 without idempotency or organization-scope enforcement. Target adds org scoping, may add
        optional idempotency, and return 201.
      x-implementation-status: "as-is (idempotency + 201 pending)"
      security:
        - cookieAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
        - name: Idempotency-Key
          in: header
          required: false
          schema:
            type: string
            format: uuid
      requestBody:
        $ref: '#/components/requestBodies/CommentCreate'
      responses:
        '200':
          description: Comment created (AS-IS returns 200; target may switch to 201)
          content:
            application/json:
              schema:
                type: object
                properties:
                  comment:
                    $ref: '#/components/schemas/Comment'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
  /api/tickets/{id}/attachments:
    post:
      summary: Create attachment upload request
      description: |
        Not implemented in current code. Target behavior should validate size/MIME, issue signed upload URL, and track scan
        status before downloads are allowed.
      x-implementation-status: "planned (no handler in code)"
      security:
        - cookieAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
        - name: Idempotency-Key
          in: header
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        $ref: '#/components/requestBodies/AttachmentCreate'
      responses:
        '201':
          description: Upload URL issued
          content:
            application/json:
              schema:
                type: object
                properties:
                  attachment:
                    $ref: '#/components/schemas/Attachment'
                  uploadUrl:
                    type: string
                    format: uri
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
  /api/tickets/{id}/attachments/{attachmentId}:
    get:
      summary: Get attachment download link
      description: |
        Not implemented in current code. Target behavior should enforce organization ownership and attachment scan status
        before issuing download URLs.
      x-implementation-status: "planned (no handler in code)"
      security:
        - cookieAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
        - name: attachmentId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Download link
          content:
            application/json:
              schema:
                type: object
                properties:
                  attachment:
                    $ref: '#/components/schemas/Attachment'
                  downloadUrl:
                    type: string
                    format: uri
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
